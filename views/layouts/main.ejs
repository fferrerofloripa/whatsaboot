<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'WhatsaBoot' %></title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='6' fill='%2325D366'/><text x='8' y='12' text-anchor='middle' fill='white' font-size='10'>W</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Socket.IO Client -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Custom Styles -->
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        @media (max-width: 768px) {
            .sidebar-hidden {
                transform: translateX(-100%);
            }
        }
        
        .pulse-green {
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0%, 100% { background-color: #10b981; }
            50% { background-color: #059669; }
        }
        
        .toast {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .toast.show {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
        <!-- Sidebar -->
        <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg sidebar-transition md:translate-x-0 sidebar-hidden">
            <div class="flex items-center justify-center h-16 gradient-bg">
                <h1 class="text-xl font-bold text-white">
                    <i class="fab fa-whatsapp mr-2"></i>
                    WhatsaBoot
                </h1>
            </div>
            
            <nav class="mt-8">
                <div class="px-4 space-y-2">
                    <a href="/dashboard" class="flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100 <%= (typeof currentPath !== 'undefined' && currentPath === '/dashboard') ? 'bg-blue-50 text-blue-700' : '' %>">
                        <i class="fas fa-tachometer-alt mr-3"></i>
                        Dashboard
                    </a>
                    
                    <% if (typeof isAdmin !== 'undefined' && isAdmin) { %>
                    <div class="pt-4">
                        <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Administración</p>
                        <div class="mt-2 space-y-1">
                            <a href="/admin" class="flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100 <%= (typeof currentPath !== 'undefined' && currentPath.startsWith('/admin') && currentPath === '/admin') ? 'bg-blue-50 text-blue-700' : '' %>">
                                <i class="fas fa-cog mr-3"></i>
                                Panel Admin
                            </a>
                            <a href="/admin/users" class="flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100 <%= (typeof currentPath !== 'undefined' && currentPath === '/admin/users') ? 'bg-blue-50 text-blue-700' : '' %>">
                                <i class="fas fa-users mr-3"></i>
                                Usuarios
                            </a>
                            <a href="/admin/numbers" class="flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100 <%= (typeof currentPath !== 'undefined' && currentPath === '/admin/numbers') ? 'bg-blue-50 text-blue-700' : '' %>">
                                <i class="fas fa-phone mr-3"></i>
                                Números
                            </a>
                            <a href="/admin/logs" class="flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100 <%= (typeof currentPath !== 'undefined' && currentPath.startsWith('/admin/logs')) ? 'bg-blue-50 text-blue-700' : '' %>">
                                <i class="fas fa-clipboard-list mr-3"></i>
                                Logs y Debugging
                            </a>
                        </div>
                    </div>
                    <% } %>
                    
                    <div class="pt-4">
                        <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Mi Cuenta</p>
                        <div class="mt-2 space-y-1">
                            <a href="/dashboard/settings" class="flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100 <%= (typeof currentPath !== 'undefined' && currentPath === '/dashboard/settings') ? 'bg-blue-50 text-blue-700' : '' %>">
                                <i class="fas fa-user-cog mr-3"></i>
                                Configuración
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- User info -->
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t">
                <div class="flex items-center">
                    <img src="<%= user.avatar || '/images/default-avatar.png' %>" alt="Avatar" class="w-8 h-8 rounded-full">
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-700"><%= user.displayName %></p>
                        <p class="text-xs text-gray-500"><%= user.role %></p>
                    </div>
                    <form action="/auth/logout" method="POST" class="ml-auto">
                        <button type="submit" class="text-gray-400 hover:text-gray-600" title="Cerrar sesión">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Main content -->
        <div class="md:pl-64">
            <!-- Top bar -->
            <header class="bg-white shadow-sm border-b">
                <div class="flex items-center justify-between px-6 py-4">
                    <button id="sidebar-toggle" class="md:hidden text-gray-600 hover:text-gray-900">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Connection status -->
                        <div id="connection-status" class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-green-500 rounded-full pulse-green mr-2"></div>
                            <span class="text-gray-600">Conectado</span>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Page content -->
            <main class="p-6">
                <%- body %>
            </main>
        </div>
        
        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 z-40 bg-black bg-opacity-50 hidden md:hidden"></div>
        
    <% } else { %>
        <!-- Login layout -->
        <main class="min-h-screen">
            <%- body %>
        </main>
    <% } %>
    
    <!-- Toast notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center h-full">
            <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Cargando...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Global JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Sidebar toggle for mobile
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('sidebar-hidden');
                    sidebarOverlay.classList.toggle('hidden');
                });
            }
            
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.add('sidebar-hidden');
                    sidebarOverlay.classList.add('hidden');
                });
            }
            
            <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
            // Socket.IO connection
            const socket = io();
            
            socket.on('connect', function() {
                console.log('Conectado a Socket.IO');
                updateConnectionStatus(true);
            });
            
            socket.on('disconnect', function() {
                console.log('Desconectado de Socket.IO');
                updateConnectionStatus(false);
            });
            
            // QR Code events
            socket.on('qr_generated', function(data) {
                console.log('QR Code generado para instancia:', data.instanceId);
                if (window.updateQRCode) {
                    window.updateQRCode(data.qrCode);
                }
                showToast('QR Code generado. Escanea con tu teléfono.', 'info');
            });
            
            socket.on('client_ready', function(data) {
                console.log('Cliente listo:', data);
                if (window.updateInstanceStatus) {
                    window.updateInstanceStatus(data.instanceId, 'connected', data.phoneNumber);
                }
                showToast('WhatsApp conectado exitosamente!', 'success');
            });
            
            socket.on('client_disconnected', function(data) {
                console.log('Cliente desconectado:', data);
                if (window.updateInstanceStatus) {
                    window.updateInstanceStatus(data.instanceId, 'disconnected');
                }
                showToast('WhatsApp desconectado', 'warning');
            });
            
            socket.on('auth_failure', function(data) {
                console.log('Fallo de autenticación:', data);
                if (window.updateInstanceStatus) {
                    window.updateInstanceStatus(data.instanceId, 'error');
                }
                showToast('Error de autenticación en WhatsApp', 'error');
            });
            <% } %>
        });
        
        // Utility functions
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                const dot = statusEl.querySelector('div');
                const text = statusEl.querySelector('span');
                
                if (connected) {
                    dot.className = 'w-2 h-2 bg-green-500 rounded-full pulse-green mr-2';
                    text.textContent = 'Conectado';
                } else {
                    dot.className = 'w-2 h-2 bg-red-500 rounded-full mr-2';
                    text.textContent = 'Desconectado';
                }
            }
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg max-w-sm`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
        
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
        
        // API helper
        async function apiCall(url, options = {}) {
            try {
                showLoading();
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Error en la petición');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message, 'error');
                throw error;
            } finally {
                hideLoading();
            }
        }
    </script>
    <script src="/js/dashboard.js"></script>
</body>
</html>
