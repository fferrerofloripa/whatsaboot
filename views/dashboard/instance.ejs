<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex items-center justify-between">
            <div>
                <nav class="flex items-center space-x-2 text-sm text-gray-500 mb-2">
                    <a href="/dashboard" class="hover:text-gray-700">Dashboard</a>
                    <i class="fas fa-chevron-right text-xs"></i>
                    <span class="text-gray-900">Configurar Instancia</span>
                </nav>
                <h1 class="text-2xl font-bold text-gray-900"><%= instance.numberName %></h1>
                <p class="text-gray-600 mt-1">Gestionar instancia de WhatsApp y respuestas automáticas</p>
            </div>
            <div class="flex items-center space-x-4">
                <% if (instance.status === 'connected') { %>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        <i class="fas fa-circle text-green-400 mr-2" style="font-size: 6px;"></i>
                        Conectado
                    </span>
                <% } else { %>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        <i class="fas fa-circle text-gray-400 mr-2" style="font-size: 6px;"></i>
                        <%= instance.status %>
                    </span>
                <% } %>
            </div>
        </div>
    </div>
    
    <!-- Instance Status Card -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Estado de la Conexión</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-sm font-medium text-gray-700 mb-3">Información General</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Nombre:</span>
                        <span class="text-sm font-medium text-gray-900"><%= instance.numberName %></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Estado:</span>
                        <span class="text-sm font-medium text-gray-900"><%= instance.status %></span>
                    </div>
                    <% if (instance.phoneNumber) { %>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Número:</span>
                            <span class="text-sm font-medium text-gray-900">+<%= instance.phoneNumber %></span>
                        </div>
                    <% } %>
                    <% if (instance.lastConnection) { %>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Última conexión:</span>
                            <span class="text-sm font-medium text-gray-900"><%= new Date(instance.lastConnection).toLocaleString('es-ES') %></span>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <div>
                <h3 class="text-sm font-medium text-gray-700 mb-3">Controles</h3>
                <div class="space-y-3">
                    <% if (instance.status === 'disconnected' || instance.status === 'error') { %>
                        <button onclick="connectInstance(<%= instance.id %>)" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                            <i class="fas fa-play mr-2"></i>
                            Conectar WhatsApp
                        </button>
                    <% } else if (instance.status === 'connected') { %>
                        <button onclick="disconnectInstance(<%= instance.id %>)" 
                                class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                            <i class="fas fa-stop mr-2"></i>
                            Desconectar
                        </button>
                    <% } %>
                    
                    <button onclick="refreshStatus(<%= instance.id %>)" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Actualizar Estado
                    </button>
                    
                    <button onclick="deleteInstance(<%= instance.id %>)" 
                            class="w-full bg-red-800 hover:bg-red-900 text-white px-4 py-2 rounded-lg flex items-center justify-center mt-4 border-t pt-4" 
                            title="Eliminar esta instancia permanentemente">
                        <i class="fas fa-trash mr-2"></i>
                        Eliminar Instancia
                    </button>
                </div>
            </div>
        </div>
        
        <!-- QR Code Display -->
        <% if (instance.status === 'qr_pending' && instance.qrCode) { %>
            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="text-sm font-medium text-yellow-800 mb-3">Escanea el Código QR</h3>
                <div class="text-center">
                    <img src="<%= instance.qrCode %>" alt="QR Code" class="mx-auto max-w-xs h-auto border rounded-lg">
                    <p class="text-xs text-yellow-700 mt-2">
                        Abre WhatsApp > Menú (⋮) > Dispositivos vinculados > Vincular dispositivo
                    </p>
                </div>
            </div>
        <% } %>
        
        <!-- Error Display -->
        <% if (instance.status === 'error' && instance.errorMessage) { %>
            <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <h3 class="text-sm font-medium text-red-800 mb-2">Error de Conexión</h3>
                <p class="text-sm text-red-700"><%= instance.errorMessage %></p>
            </div>
        <% } %>
    </div>
    
    <!-- Auto Responses -->
    <div class="bg-white rounded-lg shadow-sm">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Respuestas Automáticas</h2>
                <button onclick="openAddResponseModal()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    Nueva Respuesta
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <% if (autoResponses && autoResponses.length > 0) { %>
                <div class="space-y-4">
                    <% autoResponses.forEach(function(response) { %>
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            <%= response.keyword %>
                                        </span>
                                        <span class="text-xs text-gray-500">(<%= response.matchType %>)</span>
                                        <% if (response.priority > 1) { %>
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                Prioridad: <%= response.priority %>
                                            </span>
                                        <% } %>
                                    </div>
                                    <p class="text-sm text-gray-700 mb-2"><%= response.responseMessage %></p>
                                    <div class="flex items-center space-x-4 text-xs text-gray-500">
                                        <span>Usado <%= response.usageCount %> veces</span>
                                        <% if (response.lastUsed) { %>
                                            <span>Último uso: <%= new Date(response.lastUsed).toLocaleDateString('es-ES') %></span>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 ml-4">
                                    <button onclick="editResponse(<%= JSON.stringify(response) %>)" 
                                            class="text-blue-600 hover:text-blue-900" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteResponse(<%= response.id %>)" 
                                            class="text-red-600 hover:text-red-900" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="text-center py-12">
                    <div class="text-gray-400 text-6xl mb-4">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No hay respuestas automáticas</h3>
                    <p class="text-gray-600 mb-6">Crea tu primera respuesta automática para comenzar a automatizar conversaciones.</p>
                    <button onclick="openAddResponseModal()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>
                        Crear Primera Respuesta
                    </button>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Add/Edit Response Modal -->
<div id="responseModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center h-full p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 id="responseModalTitle" class="text-lg font-semibold text-gray-900">Nueva Respuesta Automática</h3>
            </div>
            
            <form id="responseForm" class="p-6">
                <input type="hidden" id="responseId" name="responseId">
                
                <div class="space-y-4">
                    <div>
                        <label for="keyword" class="block text-sm font-medium text-gray-700 mb-2">
                            Palabra Clave
                        </label>
                        <input type="text" id="keyword" name="keyword" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Ej: hola, precio, información">
                    </div>
                    
                    <div>
                        <label for="responseMessage" class="block text-sm font-medium text-gray-700 mb-2">
                            Mensaje de Respuesta
                        </label>
                        <textarea id="responseMessage" name="responseMessage" rows="3" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Escribe la respuesta automática..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="matchType" class="block text-sm font-medium text-gray-700 mb-2">
                                Tipo de Coincidencia
                            </label>
                            <select id="matchType" name="matchType" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="contains">Contiene</option>
                                <option value="exact">Exacta</option>
                                <option value="starts_with">Comienza con</option>
                                <option value="ends_with">Termina con</option>
                                <option value="regex">Expresión regular</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
                                Prioridad
                            </label>
                            <input type="number" id="priority" name="priority" min="1" max="10" value="1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="caseSensitive" name="caseSensitive" 
                               class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="caseSensitive" class="text-sm text-gray-700">
                            Sensible a mayúsculas/minúsculas
                        </label>
                    </div>
                </div>
            </form>
            
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeResponseModal()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Cancelar
                </button>
                <button onclick="saveResponse()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const instanceId = <%= instance.id %>;
    
    // Instance control functions
    async function connectInstance(id) {
        try {
            const result = await apiCall(`/api/bot/instances/${id}/connect`, {
                method: 'POST'
            });
            showToast(result.message, 'success');
            setTimeout(() => location.reload(), 2000);
        } catch (error) {
            console.error('Error connecting instance:', error);
        }
    }
    
    async function disconnectInstance(id) {
        if (!confirm('¿Estás seguro de que quieres desconectar esta instancia?')) {
            return;
        }
        
        try {
            const result = await apiCall(`/api/bot/instances/${id}/disconnect`, {
                method: 'POST'
            });
            showToast(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            console.error('Error disconnecting instance:', error);
        }
    }
    
    async function refreshStatus(id) {
        try {
            const result = await apiCall(`/api/bot/instances/${id}/status`);
            if (result.success) {
                location.reload();
            }
        } catch (error) {
            console.error('Error refreshing status:', error);
        }
    }
    
    // Response modal functions
    function openAddResponseModal() {
        document.getElementById('responseModalTitle').textContent = 'Nueva Respuesta Automática';
        document.getElementById('responseForm').reset();
        document.getElementById('responseId').value = '';
        document.getElementById('responseModal').classList.remove('hidden');
    }
    
    function editResponse(response) {
        document.getElementById('responseModalTitle').textContent = 'Editar Respuesta Automática';
        document.getElementById('responseId').value = response.id;
        document.getElementById('keyword').value = response.keyword;
        document.getElementById('responseMessage').value = response.responseMessage;
        document.getElementById('matchType').value = response.matchType;
        document.getElementById('priority').value = response.priority;
        document.getElementById('caseSensitive').checked = response.caseSensitive;
        document.getElementById('responseModal').classList.remove('hidden');
    }
    
    function closeResponseModal() {
        document.getElementById('responseModal').classList.add('hidden');
    }
    
    async function saveResponse() {
        const formData = new FormData(document.getElementById('responseForm'));
        const data = Object.fromEntries(formData);
        const responseId = data.responseId;
        
        // Convert checkbox to boolean
        data.caseSensitive = document.getElementById('caseSensitive').checked;
        data.priority = parseInt(data.priority);
        
        try {
            let result;
            if (responseId) {
                // Update existing response
                result = await apiCall(`/api/bot/instances/${instanceId}/autoresponses/${responseId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            } else {
                // Create new response
                result = await apiCall(`/api/bot/instances/${instanceId}/autoresponses`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }
            
            showToast(result.message, 'success');
            closeResponseModal();
            setTimeout(() => location.reload(), 1000);
            
        } catch (error) {
            console.error('Error saving response:', error);
        }
    }
    
    async function deleteResponse(responseId) {
        if (!confirm('¿Estás seguro de que quieres eliminar esta respuesta automática?')) {
            return;
        }
        
        try {
            const result = await apiCall(`/api/bot/instances/${instanceId}/autoresponses/${responseId}`, {
                method: 'DELETE'
            });
            
            showToast(result.message, 'success');
            setTimeout(() => location.reload(), 1000);
            
        } catch (error) {
            console.error('Error deleting response:', error);
        }
    }
    
    // Close modal when clicking outside
    document.getElementById('responseModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeResponseModal();
        }
    });
</script>
